<!DOCTYPE html>
<html>

<head>
    <title>vgrid-mapbox Demo</title>

    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css" rel="stylesheet" />

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        .projection-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            font-family: Arial, sans-serif;
            width: 180px;
        }

        .projection-panel label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }

        .projection-panel select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .projection-panel select:hover {
            border-color: #999;
        }

        .projection-panel select:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.2);
        }

        .projection-panel button {
            width: 100%;
            margin-top: 12px;
            padding: 8px 12px;
            border: 1px solid #0066cc;
            border-radius: 4px;
            font-size: 14px;
            background: #0066cc;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .projection-panel button:hover {
            background: #0052a3;
            border-color: #0052a3;
        }

        .projection-panel button:active {
            background: #003d7a;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div class="projection-panel">
        <label for="projection-select">Projection:</label>
        <select id="projection-select">
            <option value="equalEarth">Equal Earth</option>
            <option value="albers">Albers</option>
            <option value="mercator">Mercator</option>
            <option value="lambertConformalConic">Lambert Conformal Conic</option>
            <option value="winkelTripel">Winkel Tripel</option>
            <option value="naturalEarth">Natural Earth</option>
            <option value="equirectangular">Equirectangular</option>
            <option value="globe">Globe</option>
        </select>
        <button onclick="exportToGeoJSON()">Export to GeoJSON</button>
    </div>
    <script type="module">
        // ðŸ”‘ Add your Mapbox access token
        mapboxgl.accessToken = "pk.eyJ1IjoidGhhbmdxZCIsImEiOiJucHFlNFVvIn0.j5yb-N8ZR3d4SJAYZz-TZA";

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'https://raw.githubusercontent.com/opengeoshub/vstyles/main/versatiles/eclipse.json',
            center: [0, 0],
            zoom: 1.2,
            projection: { name: 'equalEarth' }
        });
        map.addControl(new mapboxgl.NavigationControl())

        function formatNumber(value, digits = 2) {
            return typeof value === 'number' ? value.toFixed(digits) : (value ?? 'N/A');
        }

        function formatWithSeparators(value) {
            return typeof value === 'number' ? value.toLocaleString() : (value ?? 'N/A');
        }

        function addH3OriginLayer() {
            map.addSource('h3-origin', {
                type: 'geojson',
                data: './h3_0_balanced_shifted.geojson'
            });
            map.addLayer({
                id: 'h3-origin-fill',
                type: 'fill',
                source: 'h3-origin',
                paint: {
                    'fill-color': 'rgba(255, 0, 0, 0.15)',
                    'fill-outline-color': 'rgba(255, 255, 255, 0.8)'
                }
            });
            map.addLayer({
                id: 'h3-origin-layer',
                type: 'line',
                source: 'h3-origin',
                paint: {
                    'line-color': '#ffffff',
                    'line-width': 1.5,
                    'line-dasharray': [2, 4, 1, 4]
                }
            });
        }

        // Projection list
        const projections = [
            { name: "equalEarth", value: "equalEarth" },
            { name: "albers", value: "albers" },
            { name: "mercator", value: "mercator" },
            { name: "lambertConformalConic", value: "lambertConformalConic" },
            { name: "winkelTripel", value: "winkelTripel" },
            { name: "naturalEarth", value: "naturalEarth" },
            { name: "equirectangular", value: "equirectangular" },
            { name: "globe", value: "globe" }
        ];

        // Set initial projection in dropdown
        const projectionSelect = document.getElementById('projection-select');
        projectionSelect.value = 'equalEarth';

        // Handle projection change
        projectionSelect.addEventListener('change', (e) => {
            const selectedProjection = e.target.value;
            map.setProjection({ name: selectedProjection });
        });

        map.on('load', () => {
            addH3OriginLayer();
        });
        map.on('click', (e) => {
            const features = map.queryRenderedFeatures(e.point, {
                layers: ['h3-origin-layer']
            });

            if (features.length) {
                const feature = features[0];  // Select the first feature if there are multiple

                // Create a popup with the feature properties
                const popupContent = `
            <strong>H3 Index: </strong> ${feature.properties.h3} <br>
            <strong>Resolution: </strong> ${feature.properties.resolution} <br>
            <strong>Center (lat, lon): </strong> ${formatNumber(feature.properties.center_lat)}, ${formatNumber(feature.properties.center_lon)} <br>
            <strong>Avg Edge Length (m): </strong> ${formatWithSeparators(feature.properties.avg_edge_len)} <br>
            <strong>Cell Area (mÂ²): </strong> ${formatWithSeparators(feature.properties.cell_area)} <br>
            <strong>Cell Perimeter (m): </strong> ${formatWithSeparators(feature.properties.cell_perimeter)}<br>
            `;
                // Create a popup and set its coordinates
                const popup = new mapboxgl.Popup()
                    .setLngLat(e.lngLat)  // Position the popup at the clicked location
                    .setHTML(popupContent) // Set the HTML content for the popup
                    .addTo(map);  // Add the popup to the map

                currentPopup = popup;

                // Add a highlight layer if it doesn't exist yet
                if (!map.getLayer('highlight-layer')) {
                    map.addLayer({
                        'id': 'highlight-layer',
                        'type': 'fill',
                        'source': {
                            'type': 'geojson',
                            'data': {
                                'type': 'FeatureCollection',
                                'features': []
                            }
                        },
                        'paint': {
                            'fill-color': 'rgba(255, 0, 0)', // Red color for highlight
                            'fill-opacity': 0.2,  // Set transparency of the highlight
                        }
                    });
                }

                // Update the source of the highlight layer with the clicked feature's geometry
                map.getSource('highlight-layer').setData({
                    'type': 'FeatureCollection',
                    'features': [feature]
                });
            }
        });
        function exportToGeoJSON() {
            const features = map.queryRenderedFeatures({ layers: ['h3-origin-layer'] });

            if (!features.length) {
                alert("No H3 grid features found in the current viewport.");
                return;
            }

            // Remove duplicates (some tiles can appear multiple times)
            // const uniqueFeatures = Array.from(new Map(
            //     features.map(f => [f.properties.h3_id, f])
            // ).values());

            const geojson = {
                type: 'FeatureCollection',
                features: features
            };

            // Download as GeoJSON file
            const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'h3-origin-export.geojson';
            a.click();
            URL.revokeObjectURL(url);
        }
        window.exportToGeoJSON = exportToGeoJSON;
    </script>
</body>

</html>