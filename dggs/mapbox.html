<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DGGS Visualization - Mapbox</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css" rel="stylesheet" />
      <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        #export-btn {
            position: absolute;
            top: 5px;
            left: 5px;
            background: white;
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }

        #projection-select {
            position: absolute;
            top: 5px;
            left: 120px;
            background: white;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            cursor: pointer;
            z-index: 1000;
            font-size: 14px;
        }

        #layer-controls {
            position: absolute;
            top: 35px;
            right: 5px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
     
    </style>
</head>

<body>

    <div id="map"></div>
    <div id="layer-controls">
        <strong>Layers</strong><br>
    </div>
    <button id="export-btn">Export PNG</button>
    <select id="projection-select">
        <option value="mercator" selected>Mercator</option>
        <option value="globe">Globe</option>
        <option value="equalEarth">Equal Earth</option>
        <option value="naturalEarth" >Natural Earth</option>
        <option value="winkelTripel">Winkel Tripel</option>
        <option value="albers">Albers</option>
        <option value="lambertConformalConic">Lambert Conformal Conic</option>
        <option value="equirectangular">Equirectangular</option>
    </select>

    <script>
        // Set your Mapbox access token
        mapboxgl.accessToken = 'pk.eyJ1IjoidGhhbmdxZCIsImEiOiJucHFlNFVvIn0.j5yb-N8ZR3d4SJAYZz-TZA';

        const map = new mapboxgl.Map({
            container: 'map',
            // style: 'https://raw.githubusercontent.com/opengeoshub/vstyles/main/vstyles/omt/dggs/dggs.json',
            style: './basic.json',
            center: [106.706585, 10.775326],
            zoom: 0,
            projection: 'mercator',
            preserveDrawingBuffer: true  // Required for exporting
        });

        let layerConfig = {}; // Store layer settings

        // Load configuration file
        fetch("config.json")
            .then(response => response.json())
            .then(config => {
                layerConfig = config;
                
                // Wait for map style to load before adding layers
                map.on("styledata", () => {                 
                    addLayersToMap(config.layers);
                    createLayerControls(config.layers);
                });
            })
            .catch(error => console.error("Error loading config:", error));

        function addLayersToMap(layers) {
            layers.forEach(layer => {
                if (map.getSource(layer.name)) return; // Prevent duplicate sources

                map.addSource(layer.name, {
                    type: "geojson",
                    data: layer.file
                });

                const lineTypeToDash = {
                    solid: null,
                    dash: [3, 3],
                    dot: [0.2, 1.5],
                    dashdot: [4, 2, 0.2, 2]
                };

                const resolvedDash = Array.isArray(layer.dash)
                    ? layer.dash
                    : (layer.lineType && lineTypeToDash[layer.lineType]) || null;

                const defaultTransparency = typeof layer.width === "number" ? 1 : 0.6;
                const transparency = Math.max(0, Math.min(1, layer.transparency ?? defaultTransparency));

                // if (typeof layer.width === "number") {
                    map.addLayer({
                        id: layer.name,
                        type: "line",
                        source: layer.name,
                        paint: {
                            "line-color": layer.color,
                            "line-width": layer.width || 2,
                            "line-opacity": transparency,
                            ...(resolvedDash ? { "line-dasharray": resolvedDash } : {})
                        }
                    });
                // }
                // } else {
                //     map.addLayer({
                //         id: layer.name,
                //         type: "fill",
                //         source: layer.name,
                //         paint: {
                //             // "fill-color": layer.color,
                //             "fill-opacity": 0,
                //             "fill-outline-color": layer.outlineColor || layer.color
                //         }
                //     });
                // }

                const wantsLabel = layer.label === true || layer.lable === true;
                const labelField = layer.labelField || (Array.isArray(layer.attributes) && layer.attributes.length > 0 ? layer.attributes[0] : null);
                if (wantsLabel && labelField) {
                    map.addLayer({
                        id: `${layer.name}-label`,
                        type: "symbol",
                        source: layer.name,
                        layout: {
                            "text-field": ["get", labelField],
                            "text-size": 14
                        },
                        paint: {
                            "text-color": "#000000",
                            "text-halo-color": "#ffffff",
                            "text-halo-width": 2
                        }
                    });
                }

                // Uncheck all layers by default
                map.setLayoutProperty(layer.name, 'visibility', 'none');
                if (map.getLayer(`${layer.name}-label`)) {
                    map.setLayoutProperty(`${layer.name}-label`, 'visibility', 'none');
                }
            });
        }

        function createLayerControls(layers) {
            const controls = document.getElementById("layer-controls");
            controls.innerHTML = "<strong>Layers</strong><br>"; // Reset controls

            layers.forEach(layer => {
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.checked = false;
                checkbox.id = `chk-${layer.name}`;
                checkbox.addEventListener("change", () => toggleLayer(layer.name, checkbox.checked));

                const label = document.createElement("label");
                label.htmlFor = `chk-${layer.name}`;
                label.textContent = layer.name;

                controls.appendChild(checkbox);
                controls.appendChild(label);
                controls.appendChild(document.createElement("br"));
            });
        }

        function toggleLayer(layerName, isVisible) {
            map.setLayoutProperty(layerName, 'visibility', isVisible ? 'visible' : 'none');
            if (map.getLayer(`${layerName}-label`)) {
                map.setLayoutProperty(`${layerName}-label`, 'visibility', isVisible ? 'visible' : 'none');
            }
        }

        // Show popup on click
        map.on("click", (e) => {
            const features = map.queryRenderedFeatures(e.point);
            if (features.length) {
                const feature = features[0];
                const layerName = feature.layer.id;
                const layerSettings = layerConfig.layers.find(l => l.name === layerName);
                if (!layerSettings) return;

                let popupContent = `<strong>${layerName}</strong><br>`;
                layerSettings.attributes.forEach(attr => {
                    popupContent += `<strong>${attr}:</strong> ${feature.properties[attr] || "N/A"}<br>`;
                });

                new mapboxgl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(popupContent)
                    .addTo(map);
            }
        });

        // Projection change handler
        document.getElementById('projection-select').addEventListener('change', (e) => {
            const projection = e.target.value;
            map.setProjection(projection);
        });

        // Set default projection to globe
        document.getElementById('export-btn').addEventListener('click', () => {
        map.once('render', () => {
            const canvas = map.getCanvas();
            const image = canvas.toDataURL("image/png");
            
            // Download image
            const link = document.createElement("a");
            link.href = image;
            link.download = "map-export.png";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        map.triggerRepaint();  // Ensure rendering is complete
    });

    </script>

</body>

</html>

