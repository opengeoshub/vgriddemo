<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>D3 Map Projection Transitions</title>
<style>

body {
  margin: 0;
  padding: 0;
  width: 100vw;
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: #090909;
  font-family: Arial, sans-serif;
  overflow: hidden;
}

h1 {
  color: #fff;
  margin-bottom: 20px;
  text-align: center;
  font-size: 28px;
  font-weight: 300;
}

#map-wrapper {
  position: relative;
  width: 960px;
  height: 520px;
}

#controls {
  position: absolute;
  left: 50%;
  bottom: 0px;
  transform: translateX(-50%);
  display: flex;
  gap: 12px;
  align-items: center;
}

#projection-menu {
  position: static;
}

#pause-btn {
  position: static;
  height: 21px;
  box-sizing: border-box;
}

.stroke {
  fill: none;
  stroke: #000;
  stroke-width: 3px;
}

.fill {
  fill: #fff;
}

.graticule {
  fill: none;
  stroke: #777;
  stroke-width: .5px;
  stroke-opacity: .5;
}

.land {
  fill: #4a90e2 ;
  fill-opacity: .4;
  stroke-width: 1px;
  stroke: #090909;
  stroke-opacity: .6;
}

.boundary {
  fill: none;
  stroke: #fff;
  stroke-width: .5px;
}

.head-outline {
  fill: none;
  stroke: red;
  stroke-width: 2px;
}

#head-toggle {
  position: absolute;
  top: 10px;
  left: 0px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

#head-toggle label {
  color: #fff;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}

#head-toggle input[type="checkbox"] {
  margin: 0;
}

</style>
</head>
<body>
<h1>D3 Map Projection Transitions</h1>
<div id="map-wrapper">
  <div id="head-toggle">
    <select id="head-select">
      <option value="man">Man's Head</option>
      <option value="woman">Woman's Head</option>
      <option value="none">None</option>
    </select>
    <label>
      <input type="checkbox" id="worldmap-checkbox" checked>
      World Map
    </label>
    <label>
      <input type="checkbox" id="graticule-checkbox" checked>
      Graticule
    </label>
  </div>
  <div id="controls">
    <select id="projection-menu"></select>
    <button id="pause-btn">Pause</button>
  </div>
</div>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/d3.geo.projection.v0.min.js"></script>
<script src="http://d3js.org/d3.geo.polyhedron.v0.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script>

var width = 960,
    height = 500;

var projections = [
  {name: "Aitoff", projection: d3.geo.aitoff()},
  {name: "Albers", projection: d3.geo.albers().scale(145).parallels([20, 50])},
  {name: "August", projection: d3.geo.august().scale(60)},
  {name: "Baker", projection: d3.geo.baker().scale(100)},
  {name: "Berghaus", projection: d3.geo.berghaus().scale(100)},
  {name: "Boggs", projection: d3.geo.boggs()},
  {name: "Bonne", projection: d3.geo.bonne().scale(120)},
  {name: "Bromley", projection: d3.geo.bromley()},
  {name: "Collignon", projection: d3.geo.collignon().scale(93)},
  {name: "Craster Parabolic", projection: d3.geo.craster()},
  {name: "Eckert I", projection: d3.geo.eckert1().scale(165)},
  {name: "Eckert II", projection: d3.geo.eckert2().scale(165)},
  {name: "Eckert III", projection: d3.geo.eckert3().scale(180)},
  {name: "Eckert IV", projection: d3.geo.eckert4().scale(180)},
  {name: "Eckert V", projection: d3.geo.eckert5().scale(170)},
  {name: "Eckert VI", projection: d3.geo.eckert6().scale(170)},
  {name: "Eisenlohr", projection: d3.geo.eisenlohr().scale(60)},
  {name: "Equirectangular (Plate Carrée)", projection: d3.geo.equirectangular()},
  {name: "Fahey", projection: d3.geo.fahey().scale(120)},
  {name: "Gall Stereographic", projection: d3.geo.cylindricalStereographic().parallel(45).scale(140)},
  {name: "Ginzburg IV", projection: d3.geo.ginzburg4().scale(120)},
  {name: "Ginzburg V", projection: d3.geo.ginzburg5().scale(120)},
  {name: "Ginzburg VI", projection: d3.geo.ginzburg6().scale(120)},
  {name: "Ginzburg VIII", projection: d3.geo.ginzburg8().scale(120)},
  {name: "Ginzburg IX", projection: d3.geo.ginzburg9().scale(120)},
  {name: "Gringorten", projection: d3.geo.gringorten().scale(220)},
  {name: "Guyou", projection: d3.geo.guyou().scale(150)},
  {name: "Hammer", projection: d3.geo.hammer().scale(165)},
  {name: "Hammer Retroazimuthal", projection: d3.geo.hammerRetroazimuthal().scale(90)},
  {name: "HEALPix", projection: d3.geo.healpix()},
  {name: "Hill", projection: d3.geo.hill().scale(120)},
  {name: "Goode Homolosine", projection: d3.geo.homolosine()},
  {name: "Kavrayskiy VII", projection: d3.geo.kavrayskiy7()},
  {name: "Lambert cylindrical equal-area", projection: d3.geo.cylindricalEqualArea()},
  {name: "Lagrange", projection: d3.geo.lagrange().scale(120)},
  {name: "Larrivée", projection: d3.geo.larrivee().scale(95)},
  {name: "Laskowski", projection: d3.geo.laskowski().scale(120)},
  {name: "Loximuthal", projection: d3.geo.loximuthal()},
  // {name: "Mercator", projection: d3.geo.mercator().scale(100)},
  {name: "Miller", projection: d3.geo.miller().scale(100)},
  {name: "McBryde–Thomas Flat-Polar Parabolic", projection: d3.geo.mtFlatPolarParabolic()},
  {name: "McBryde–Thomas Flat-Polar Quartic", projection: d3.geo.mtFlatPolarQuartic()},
  {name: "McBryde–Thomas Flat-Polar Sinusoidal", projection: d3.geo.mtFlatPolarSinusoidal()},
  {name: "Mollweide", projection: d3.geo.mollweide().scale(165)},
  {name: "Natural Earth", projection: d3.geo.naturalEarth()},
  {name: "Nell–Hammer", projection: d3.geo.nellHammer()},
  {name: "Orthographic", projection: d3.geo.orthographic().scale(200)},
  {name: "Polyconic", projection: d3.geo.polyconic().scale(100)},
  {name: "Rectangular Polyconic", projection: d3.geo.rectangularPolyconic().scale(120)},
  {name: "Robinson", projection: d3.geo.robinson()},
  {name: "Sinusoidal", projection: d3.geo.sinusoidal()},
  {name: "Sinu-Mollweide", projection: d3.geo.sinuMollweide()},
  {name: "Stereographic", projection: d3.geo.stereographic()},
  {name: "Times", projection: d3.geo.times().scale(140)},
  {name: "van der Grinten", projection: d3.geo.vanDerGrinten().scale(75)},
  {name: "van der Grinten II", projection: d3.geo.vanDerGrinten2().scale(75)},
  {name: "van der Grinten III", projection: d3.geo.vanDerGrinten3().scale(75)},
  {name: "van der Grinten IV", projection: d3.geo.vanDerGrinten4().scale(120)},
  {name: "Wagner IV", projection: d3.geo.wagner4()},
  {name: "Wagner VI", projection: d3.geo.wagner6()},
  {name: "Wagner VII", projection: d3.geo.wagner7()},
  {name: "Waterman", projection: d3.geo.polyhedron.waterman().scale(70)},
  {name: "Winkel Tripel", projection: d3.geo.winkel3()}
];


projections.forEach(function(o) {
  o.projection.rotate([0, 0]).center([0, 0]);
});

var autoDelay = 2000,
    autoPlay = true,
    interval,
    i = 0;

var projection = projections[i].projection;

var path = d3.geo.path()
    .projection(projection);

var graticule = d3.geo.graticule();

var svg = d3.select("#map-wrapper").append("svg")
    .attr("width", width)
    .attr("height", height);

var headPath;
var landPath;
var graticulePath;
var headData = {};
var currentHead = "man";

svg.append("defs").append("path")
    .datum({type: "Sphere"})
    .attr("id", "sphere")
    .attr("d", path);

svg.append("use")
    .attr("class", "stroke")
    .attr("xlink:href", "#sphere");

svg.append("use")
    .attr("class", "fill")
    .attr("xlink:href", "#sphere");

graticulePath = svg.append("path")
    .datum(graticule)
    .attr("class", "graticule")
    .attr("d", path);

d3.json("./world-110m.json", function(error, world) {
  if (error) throw error;

  landPath = svg.insert("path", ".land")
      .datum(topojson.feature(world, world.objects.land))
      .attr("class", "land")
      .attr("d", path);

  headPath = svg.append("path")
      .attr("class", "head-outline");

  updateHeadPath();
  startAutoPlay(true);
});

d3.json("./man_head.geojson", function(error, head) {
  if (error) throw error;

  headData.man = head;
  if (currentHead === "man") {
    updateHeadPath();
  }
});

d3.json("./woman_head.geojson", function(error, head) {
  if (error) throw error;

  headData.woman = head;
  if (currentHead === "woman") {
    updateHeadPath();
  }
});


var menu = d3.select("#projection-menu")
    .on("change", change);

var pauseButton = d3.select("#pause-btn")
    .on("click", toggleAutoPlay);

var headSelect = d3.select("#head-select")
    .on("change", function() {
      currentHead = this.value;
      updateHeadPath();
    });

var worldMapCheckbox = d3.select("#worldmap-checkbox")
    .on("change", function() {
      if (landPath) {
        landPath.style("display", this.checked ? "block" : "none");
      }
    });

var graticuleCheckbox = d3.select("#graticule-checkbox")
    .on("change", function() {
      if (graticulePath) {
        graticulePath.style("display", this.checked ? "block" : "none");
      }
    });

menu.selectAll("option")
    .data(projections)
  .enter().append("option")
    .text(function(d) { return d.name; });

function change() {
  stopAutoPlay();
  i = this.selectedIndex;
  update(projections[i]);
}

function update(option) {
  svg.selectAll("path").transition()
      .duration(750)
      .attrTween("d", projectionTween(projection, projection = option.projection));
}

function nextProjection() {
  i = (i + 1) % projections.length;
  menu.property("selectedIndex", i);
  update(projections[i]);
}

function startAutoPlay(immediate) {
  if (interval) clearInterval(interval);
  if (!autoPlay) return;
  if (immediate) nextProjection();
  interval = setInterval(nextProjection, autoDelay);
}

function stopAutoPlay() {
  clearInterval(interval);
  interval = null;
}

function toggleAutoPlay() {
  autoPlay = !autoPlay;
  pauseButton.text(autoPlay ? "Pause" : "Resume");
  if (autoPlay) {
    startAutoPlay(true);
  } else {
    stopAutoPlay();
  }
}

function projectionTween(projection0, projection1) {
  return function(d) {
    var t = 0;

    var projection = d3.geo.projection(project)
        .scale(1)
        .translate([width / 2, height / 2]);

    var path = d3.geo.path()
        .projection(projection);

    function project(λ, φ) {
      λ *= 180 / Math.PI, φ *= 180 / Math.PI;
      var p0 = projection0([λ, φ]), p1 = projection1([λ, φ]);
      return [(1 - t) * p0[0] + t * p1[0], (1 - t) * -p0[1] + t * -p1[1]];
    }

    return function(_) {
      t = _;
      return path(d);
    };
  };
}

function updateHeadPath() {
  if (!headPath) return;
  
  if (currentHead === "none") {
    // Hide head outline for None
    headPath.style("display", "none");
  } else {
    // Show head outline for man or woman
    headPath.style("display", "block");
    var data = headData[currentHead];
    if (!data) return;
    headPath.datum(data)
        .attr("d", path);
  }
}

</script>
</body>
</html>